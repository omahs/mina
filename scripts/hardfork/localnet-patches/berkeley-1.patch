From 9be44160cc6b5b5c5013d1ed6cb67719049ee660 Mon Sep 17 00:00:00 2001
From: georgeee <george.agapov@gmail.com>
Date: Fri, 26 Jan 2024 07:40:10 +0100
Subject: [PATCH 1/3] Fix Ivar.fill bug in Transition_frontier_controller

---
 .../transition_frontier_controller.ml                        | 5 ++---
 1 file changed, 2 insertions(+), 3 deletions(-)

diff --git a/src/lib/transition_frontier_controller/transition_frontier_controller.ml b/src/lib/transition_frontier_controller/transition_frontier_controller.ml
index 097a8fa135..2e417cde55 100644
--- a/src/lib/transition_frontier_controller/transition_frontier_controller.ml
+++ b/src/lib/transition_frontier_controller/transition_frontier_controller.ml
@@ -128,7 +128,7 @@ let run ~context:(module Context : CONTEXT) ~trust_system ~verifier ~network
     ~context:(module Context)
     ~trust_system ~verifier ~network ~frontier ~catchup_job_reader
     ~catchup_breadcrumbs_writer ~unprocessed_transition_cache ;
-  Strict_pipe.Reader.iter_without_pushback clear_reader ~f:(fun _ ->
+  upon (Strict_pipe.Reader.read clear_reader) (fun _ ->
       let open Strict_pipe.Writer in
       kill valid_transition_writer ;
       kill primary_transition_writer ;
@@ -137,6 +137,5 @@ let run ~context:(module Context : CONTEXT) ~trust_system ~verifier ~network
       kill catchup_breadcrumbs_writer ;
       if Ivar.is_full clean_up_catchup_scheduler then
         [%log error] "Ivar.fill bug is here!" ;
-      Ivar.fill clean_up_catchup_scheduler () )
-  |> don't_wait_for ;
+      Ivar.fill clean_up_catchup_scheduler () ) ;
   processed_transition_reader
-- 
2.18.1

